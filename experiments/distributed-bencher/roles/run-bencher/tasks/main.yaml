- name: Pull bencher docker images
  docker_image:
    name: "{{ bencher_image }}"
    source: pull
    force_source: true

- name: Build client_urls variable
  set_fact:
    client_urls: "http://{{ hostvars[groups['cluster'][0]]['ansible_default_ipv4']['address'] }}:2379{% for i in range(2, node_count | int + 1) %},http://{{ hostvars[groups['cluster'][(i - 1) % (groups['cluster'] | length)]]['ansible_default_ipv4']['address'] }}:{{ 2379 + ((i - 1) * 10) }}{% endfor %}"

- name: Build metrics_urls variable
  set_fact:
    metrics_urls: "http://{{ hostvars[groups['cluster'][0]]['ansible_default_ipv4']['address'] }}:2381{% for i in range(2, node_count | int + 1) %},http://{{ hostvars[groups['cluster'][(i - 1) % (groups['cluster'] | length)]]['ansible_default_ipv4']['address'] }}:{{ 2381 + ((i - 1) * 10) }}{% endfor %}"

- name: Start the bencher cluster (PutRange)
  community.docker.docker_container:
    name: "{{ bencher_name_prefix }}{{ item | int + 1 }}"
    recreate: yes
    image: "{{ bencher_image }}"
    detach: false
    network_mode: host
    command:
      - --endpoints={{ client_urls }}
      - --metrics-endpoints={{ metrics_urls }}
      - --total={{ bench_total }}
      - --interval={{ bencher_interval }}
      - bench
      - put-range
  with_sequence: start=0 count={{ bencher_count }}
  when:
    - (item|int % (ansible_play_hosts | length)) == ansible_play_hosts.index(inventory_hostname)
    - bench_type == "PutRange"

- name: Start the bencher cluster (PutSingle)
  community.docker.docker_container:
    name: "{{ bencher_name_prefix }}{{ item | int + 1 }}"
    recreate: yes
    image: "{{ bencher_image }}"
    detach: false
    network_mode: host
    command:
      - --endpoints={{ client_urls }}
      - --metrics-endpoints={{ metrics_urls }}
      - --total={{ bench_total }}
      - --interval={{ bencher_interval }}
      - bench
      - put-single
      - benchkey
  with_sequence: start=0 count={{ bencher_count }}
  when:
    - (item|int % (ansible_play_hosts | length)) == ansible_play_hosts.index(inventory_hostname)
    - bench_type == "PutSingle"

- name: Start the bencher cluster (PutRandom)
  community.docker.docker_container:
    name: "{{ bencher_name_prefix }}{{ item | int + 1 }}"
    recreate: yes
    image: "{{ bencher_image }}"
    detach: false
    network_mode: host
    command:
      - --endpoints={{ client_urls }}
      - --metrics-endpoints={{ metrics_urls }}
      - --total={{ bench_total }}
      - --interval={{ bencher_interval }}
      - bench
      - put-random
      - 1000
  with_sequence: start=0 count={{ bencher_count }}
  when:
    - (item|int % (ansible_play_hosts | length)) == ansible_play_hosts.index(inventory_hostname)
    - bench_type == "PutRandom"
