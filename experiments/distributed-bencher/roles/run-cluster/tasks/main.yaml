- name: setfact
  set_fact:
    initial_cluster: "node1=http://{{ hostvars[ansible_play_hosts[0]]['ansible_default_ipv4']['address'] }}:2380{% for i in range(2, node_count | int + 1) %},node{{ i }}=http://{{ hostvars[ansible_play_hosts[(i - 1) % (ansible_play_hosts | length)]]['ansible_default_ipv4']['address'] }}:{{ 2380 + ((i - 1) * 10) }}{% endfor %}"

- name: Start the etcd cluster
  community.docker.docker_container:
    name: "node{{ item | int + 1}}"
    recreate: yes
    image: "{{ node_image }}"
    detach: true
    network_mode: host
    command:
      - etcd
      - --name=node{{ item | int + 1 }}
      - --data-dir=/data/node{{ item }}.etcd
      - --advertise-client-urls=http://0.0.0.0:{{ 2379 + ((item | int) * 10) }}
      - --listen-client-urls=http://0.0.0.0:{{ 2379 + ((item | int) * 10) }}
      - --initial-cluster={{ initial_cluster }}
      - --listen-peer-urls=http://0.0.0.0:{{ 2380 + ((item | int) * 10) }}
      - --listen-metrics-urls=http://0.0.0.0:{{ 2381 + ((item | int) * 10) }}
  with_sequence: start=0 count={{ node_count }}
  when: (item|int % (ansible_play_hosts | length)) == ansible_play_hosts.index(inventory_hostname)
